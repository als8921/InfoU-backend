<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>InfoU Database Admin Panel</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --toss-blue: #0064ff;
        --toss-light-blue: #e5f2ff;
        --toss-red: #ff5a5a;
        --toss-light-red: #ffebeb;
        --toss-gray-900: #191f28;
        --toss-gray-800: #333d4b;
        --toss-gray-700: #4e5968;
        --toss-gray-600: #6b7684;
        --toss-gray-500: #8b95a1;
        --toss-gray-400: #b0b8c1;
        --toss-gray-300: #c9cdd2;
        --toss-gray-200: #e5e8eb;
        --toss-gray-100: #f2f4f6;
        --toss-gray-50: #f9fafb;
        --white: #ffffff;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui,
          Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo",
          "Noto Sans KR", "Malgun Gothic", sans-serif;
        background-color: var(--toss-gray-50);
        color: var(--toss-gray-900);
        line-height: 1.6;
      }

      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        background: var(--white);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--toss-gray-200);
      }

      .header h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--toss-gray-900);
        margin-bottom: 8px;
      }

      .header p {
        font-size: 16px;
        color: var(--toss-gray-600);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        background: var(--white);
        border: 1px solid var(--toss-gray-200);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        transition: all 0.2s ease;
      }

      .stat-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        transform: translateY(-1px);
      }

      .stat-card h3 {
        font-size: 28px;
        font-weight: 700;
        color: var(--toss-blue);
        margin-bottom: 4px;
      }

      .stat-card p {
        font-size: 14px;
        color: var(--toss-gray-600);
      }

      .section {
        background: var(--white);
        border: 1px solid var(--toss-gray-200);
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
      }

      .section h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--toss-gray-900);
        margin-bottom: 24px;
      }

      .table-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .table-card {
        background: var(--toss-gray-50);
        border: 1px solid var(--toss-gray-200);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .table-card:hover {
        background: var(--toss-light-blue);
        border-color: var(--toss-blue);
        transform: translateY(-1px);
      }

      .table-card.selected {
        background: var(--toss-light-blue);
        border-color: var(--toss-blue);
      }

      .table-card h4 {
        font-size: 16px;
        font-weight: 600;
        color: var(--toss-gray-900);
        margin-bottom: 4px;
      }

      .table-card .row-count {
        font-size: 14px;
        color: var(--toss-gray-600);
      }

      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: var(--toss-blue);
        color: var(--white);
      }

      .btn-primary:hover {
        background: #0052cc;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: var(--toss-gray-100);
        color: var(--toss-gray-700);
        border: 1px solid var(--toss-gray-300);
      }

      .btn-secondary:hover {
        background: var(--toss-gray-200);
        transform: translateY(-1px);
      }

      .btn-danger {
        background: var(--toss-red);
        color: var(--white);
      }

      .btn-danger:hover {
        background: #e54545;
        transform: translateY(-1px);
      }

      .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--white);
        border: 1px solid var(--toss-gray-200);
        border-radius: 12px;
        overflow: hidden;
      }

      .table-container {
        width: 100%;
        overflow-x: auto;
        border: 1px solid var(--toss-gray-200);
        border-radius: 12px;
        background: var(--white);
      }

      .data-table th,
      .data-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--toss-gray-200);
        white-space: nowrap;
        min-width: 120px;
      }

      .data-table td {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .data-table td.expandable {
        white-space: normal;
        word-wrap: break-word;
      }

      .data-table th {
        background: var(--toss-gray-50);
        color: var(--toss-gray-800);
        font-weight: 600;
        font-size: 14px;
      }

      .data-table td {
        font-size: 14px;
        color: var(--toss-gray-700);
      }

      .cell-content {
        position: relative;
        cursor: pointer;
      }

      .cell-content:hover {
        background: var(--toss-light-blue);
      }

      .full-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--white);
        border: 1px solid var(--toss-gray-200);
        border-radius: 12px;
        padding: 24px;
        max-width: 80vw;
        max-height: 80vh;
        overflow: auto;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .full-content h3 {
        margin-bottom: 16px;
        color: var(--toss-gray-900);
      }

      .full-content pre {
        background: var(--toss-gray-50);
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .data-table tbody tr:hover {
        background: var(--toss-gray-50);
      }

      .data-table tbody tr:last-child td {
        border-bottom: none;
      }

      .json-display {
        background: var(--toss-gray-50);
        border: 1px solid var(--toss-gray-200);
        border-radius: 12px;
        padding: 20px;
        font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono",
          "Consolas", monospace;
        font-size: 13px;
        line-height: 1.5;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
        color: var(--toss-gray-800);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--toss-gray-600);
        font-size: 14px;
      }

      .error {
        background: var(--toss-light-red);
        color: var(--toss-red);
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        font-size: 14px;
        border: 1px solid var(--toss-red);
      }

      .success {
        background: #e8f5e8;
        color: #2e7d2e;
        padding: 16px;
        border-radius: 8px;
        margin: 16px 0;
        font-size: 14px;
        border: 1px solid #4caf50;
      }

      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin: 24px 0;
      }

      .pagination button {
        padding: 8px 12px;
        border: 1px solid var(--toss-gray-300);
        background: var(--white);
        color: var(--toss-gray-700);
        font-size: 14px;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
      }

      .pagination button.active {
        background: var(--toss-blue);
        color: var(--white);
        border-color: var(--toss-blue);
      }

      .pagination button:hover:not(.active) {
        background: var(--toss-gray-50);
        border-color: var(--toss-blue);
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--toss-gray-600);
      }

      .empty-state h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .empty-state p {
        font-size: 14px;
      }

      /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: var(--white);
        border-radius: 16px;
        padding: 32px;
        max-width: 600px;
        width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal h2 {
        margin-bottom: 24px;
        color: var(--toss-gray-900);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--toss-gray-800);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--toss-gray-300);
        border-radius: 8px;
        font-size: 14px;
        background: var(--white);
        color: var(--toss-gray-800);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--toss-blue);
        box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 32px;
        padding-top: 20px;
        border-top: 1px solid var(--toss-gray-200);
      }

      .table-selector {
        margin-bottom: 24px;
      }

      .table-selector select {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--toss-gray-300);
        border-radius: 8px;
        font-size: 14px;
        background: var(--white);
        color: var(--toss-gray-800);
      }

      .form-dynamic {
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.3s ease, max-height 0.3s ease;
      }

      .form-dynamic.visible {
        opacity: 1;
        max-height: 1000px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Database Admin</h1>
        <p>
          ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ íŒ¨ë„ - ëª¨ë“  í…Œì´ë¸”ê³¼ ë°ì´í„°ë¥¼ í•œ ê³³ì—ì„œ í™•ì¸í•˜ì„¸ìš”
        </p>
      </div>

      <div class="content">
        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <h3 id="totalTables">-</h3>
            <p>ì´ í…Œì´ë¸” ìˆ˜</p>
          </div>
          <div class="stat-card">
            <h3 id="totalRows">-</h3>
            <p>ì´ ë°ì´í„° í–‰ ìˆ˜</p>
          </div>
          <div class="stat-card">
            <h3 id="dbStatus">-</h3>
            <p>ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ</p>
          </div>
        </div>

        <!-- í…Œì´ë¸” ëª©ë¡ -->
        <div class="section">
          <h2>í…Œì´ë¸” ëª©ë¡</h2>
          <div class="controls">
            <button class="btn btn-primary" onclick="loadTables()">
              ìƒˆë¡œê³ ì¹¨
            </button>
            <button class="btn btn-secondary" onclick="loadAllData()">
              ì „ì²´ ë°ì´í„° ë³´ê¸°
            </button>
            <button class="btn btn-primary" onclick="showAddDataModal()">
              â• ë°ì´í„° ì¶”ê°€
            </button>
          </div>
          <div class="table-list" id="tableList">
            <div class="loading">í…Œì´ë¸” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>

        <!-- ì„ íƒëœ í…Œì´ë¸” ë°ì´í„° -->
        <div class="section" id="tableDataSection" style="display: none">
          <h2 id="tableDataTitle">í…Œì´ë¸” ë°ì´í„°</h2>
          <div class="controls">
            <button class="btn btn-primary" onclick="refreshTableData()">
              ìƒˆë¡œê³ ì¹¨
            </button>
            <button class="btn btn-secondary" onclick="showTableInfo()">
              í…Œì´ë¸” ì •ë³´
            </button>
            <button
              class="btn btn-danger"
              onclick="clearTable()"
              id="clearTableBtn"
            >
              ë°ì´í„° ì‚­ì œ
            </button>
          </div>
          <div id="tableDataContent">
            <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
          <div
            class="pagination"
            id="tablePagination"
            style="display: none"
          ></div>
        </div>

      </div>

      <!-- ë°ì´í„° ì¶”ê°€ ëª¨ë‹¬ -->
      <div id="addDataModal" class="modal" style="display: none;">
        <div class="modal-content">
          <h2>â• ë°ì´í„° ì¶”ê°€</h2>
          
          <div class="table-selector">
            <label for="tableSelect">í…Œì´ë¸” ì„ íƒ:</label>
            <select id="tableSelect" onchange="onTableSelectChange()">
              <option value="">í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”</option>
              <option value="users">Users (ì‚¬ìš©ì)</option>
              <option value="levels">Levels (ë‚œì´ë„)</option>
              <option value="main_topics">Main Topics (ë©”ì¸ í† í”½)</option>
              <option value="sub_topics">Sub Topics (ì„œë¸Œ í† í”½)</option>
              <option value="learning_paths">Learning Paths (í•™ìŠµ ê²½ë¡œ)</option>
              <option value="curriculum_items">Curriculum Items (ì»¤ë¦¬í˜ëŸ¼)</option>
              <option value="articles">Articles (ì•„í‹°í´)</option>
              <option value="user_article_reads">User Article Reads (ì½ê¸° ê¸°ë¡)</option>
            </select>
          </div>

          <div id="dynamicForm" class="form-dynamic">
            <div id="formContent"></div>
          </div>

          <div class="form-actions">
            <button class="btn btn-secondary" onclick="closeAddDataModal()">ì·¨ì†Œ</button>
            <button id="submitBtn" class="btn btn-primary" onclick="submitData()" style="display: none;">ì¶”ê°€</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTable = null;
      let currentPage = 0;
      let pageSize = 100;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", function () {
        loadStats();
        loadTables();
      });

      // í†µê³„ ì •ë³´ ë¡œë“œ
      async function loadStats() {
        try {
          const response = await fetch("/debug/db-stats");
          const data = await response.json();

          document.getElementById("totalTables").textContent =
            data.total_tables;
          document.getElementById("totalRows").textContent =
            data.total_rows.toLocaleString();
          document.getElementById("dbStatus").textContent = "âœ… ì—°ê²°ë¨";
        } catch (error) {
          console.error("í†µê³„ ë¡œë”© ì‹¤íŒ¨:", error);
          document.getElementById("dbStatus").textContent = "âŒ ì˜¤ë¥˜";
        }
      }

      // í…Œì´ë¸” ëª©ë¡ ë¡œë“œ
      async function loadTables() {
        try {
          const response = await fetch("/debug/tables");
          const data = await response.json();

          const tableList = document.getElementById("tableList");

          if (data.tables.length === 0) {
            tableList.innerHTML = `
                        <div class="empty-state">
                            <h3>í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”</p>
                        </div>
                    `;
            return;
          }

          tableList.innerHTML = "";

          for (const tableName of data.tables) {
            // ê° í…Œì´ë¸”ì˜ í–‰ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            try {
              const tableResponse = await fetch(`/debug/tables/${tableName}`);
              const tableData = await tableResponse.json();

              const tableCard = document.createElement("div");
              tableCard.className = "table-card";
              tableCard.onclick = () => selectTable(tableName);
              tableCard.innerHTML = `
                            <h4>ğŸ“Š ${tableName}</h4>
                            <div class="row-count">${tableData.row_count.toLocaleString()} í–‰</div>
                        `;

              tableList.appendChild(tableCard);
            } catch (error) {
              const tableCard = document.createElement("div");
              tableCard.className = "table-card";
              tableCard.onclick = () => selectTable(tableName);
              tableCard.innerHTML = `
                            <h4>ğŸ“Š ${tableName}</h4>
                            <div class="row-count">ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>
                        `;
              tableList.appendChild(tableCard);
            }
          }

          // í†µê³„ ìƒˆë¡œê³ ì¹¨
          loadStats();
        } catch (error) {
          console.error("í…Œì´ë¸” ë¡œë”© ì‹¤íŒ¨:", error);
          document.getElementById("tableList").innerHTML =
            '<div class="error">í…Œì´ë¸” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
      }

      // í…Œì´ë¸” ì„ íƒ
      function selectTable(tableName) {
        currentTable = tableName;
        currentPage = 0;

        // ì„ íƒëœ í…Œì´ë¸” í‘œì‹œ
        document.querySelectorAll(".table-card").forEach((card) => {
          card.classList.remove("selected");
        });
        event.target.classList.add("selected");

        // í…Œì´ë¸” ë°ì´í„° ì„¹ì…˜ í‘œì‹œ
        document.getElementById("tableDataSection").style.display = "block";
        document.getElementById(
          "tableDataTitle"
        ).textContent = `ğŸ“Š ${tableName} ë°ì´í„°`;
        document.getElementById(
          "clearTableBtn"
        ).textContent = `ğŸ—‘ï¸ ${tableName} ë°ì´í„° ì‚­ì œ`;

        loadTableData(tableName, currentPage);
      }

      // í…Œì´ë¸” ë°ì´í„° ë¡œë“œ
      async function loadTableData(tableName, page = 0) {
        try {
          const response = await fetch(
            `/debug/tables/${tableName}/data?limit=${pageSize}&offset=${
              page * pageSize
            }`
          );
          const data = await response.json();

          const content = document.getElementById("tableDataContent");

          if (data.data.length === 0) {
            content.innerHTML = '<div class="loading">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }

          // í…Œì´ë¸” ìƒì„±
          let html =
            '<div class="table-container"><table class="data-table"><thead><tr>';

          // í—¤ë”
          const columns = Object.keys(data.data[0]);
          columns.forEach((col) => {
            html += `<th>${col}</th>`;
          });
          html += "</tr></thead><tbody>";

          // ë°ì´í„° í–‰
          data.data.forEach((row) => {
            html += "<tr>";
            columns.forEach((col) => {
              let value = row[col];
              let displayValue = value;
              let isLong = false;

              if (typeof value === "object" && value !== null) {
                displayValue = JSON.stringify(value, null, 2);
                isLong = displayValue.length > 100;
              } else if (value === null) {
                displayValue = "<em>NULL</em>";
              } else if (typeof value === "string" && value.length > 100) {
                displayValue = value.substring(0, 100) + "...";
                isLong = true;
              }

              if (isLong) {
                html += `<td class="expandable"><div class="cell-content" onclick="showFullContent('${col}', ${JSON.stringify(
                  value
                ).replace(/"/g, "&quot;")})">${displayValue}</div></td>`;
              } else {
                html += `<td>${displayValue}</td>`;
              }
            });
            html += "</tr>";
          });

          html += "</tbody></table></div>";
          content.innerHTML = html;

          // í˜ì´ì§€ë„¤ì´ì…˜
          createPagination(data.total_count, page);
        } catch (error) {
          console.error("í…Œì´ë¸” ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
          document.getElementById("tableDataContent").innerHTML =
            '<div class="error">í…Œì´ë¸” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
      }

      // í˜ì´ì§€ë„¤ì´ì…˜ ìƒì„±
      function createPagination(totalCount, currentPage) {
        const totalPages = Math.ceil(totalCount / pageSize);
        const pagination = document.getElementById("tablePagination");

        if (totalPages <= 1) {
          pagination.style.display = "none";
          return;
        }

        pagination.style.display = "flex";
        pagination.innerHTML = "";

        // ì´ì „ ë²„íŠ¼
        if (currentPage > 0) {
          const prevBtn = document.createElement("button");
          prevBtn.textContent = "ì´ì „";
          prevBtn.onclick = () => {
            this.currentPage = currentPage - 1;
            loadTableData(this.currentTable, this.currentPage);
          };
          pagination.appendChild(prevBtn);
        }

        // í˜ì´ì§€ ë²ˆí˜¸
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement("button");
          pageBtn.textContent = i + 1;
          pageBtn.className = i === currentPage ? "active" : "";
          pageBtn.onclick = () => {
            this.currentPage = i;
            loadTableData(this.currentTable, i);
          };
          pagination.appendChild(pageBtn);
        }

        // ë‹¤ìŒ ë²„íŠ¼
        if (currentPage < totalPages - 1) {
          const nextBtn = document.createElement("button");
          nextBtn.textContent = "ë‹¤ìŒ";
          nextBtn.onclick = () => {
            this.currentPage = currentPage + 1;
            loadTableData(this.currentTable, this.currentPage);
          };
          pagination.appendChild(nextBtn);
        }
      }

      // í…Œì´ë¸” ë°ì´í„° ìƒˆë¡œê³ ì¹¨
      function refreshTableData() {
        if (currentTable) {
          loadTableData(currentTable, currentPage);
        }
      }

      // í…Œì´ë¸” ì •ë³´ ë³´ê¸°
      async function showTableInfo() {
        if (!currentTable) return;

        try {
          const response = await fetch(`/debug/tables/${currentTable}`);
          const data = await response.json();

          const content = document.getElementById("tableDataContent");
          content.innerHTML = `<div class="json-display">${JSON.stringify(
            data,
            null,
            2
          )}</div>`;
        } catch (error) {
          console.error("í…Œì´ë¸” ì •ë³´ ë¡œë”© ì‹¤íŒ¨:", error);
        }
      }

      // í…Œì´ë¸” ë°ì´í„° ì‚­ì œ
      async function clearTable() {
        if (!currentTable) return;

        if (
          !confirm(
            `ì •ë§ë¡œ "${currentTable}" í…Œì´ë¸”ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/debug/tables/${currentTable}`, {
            method: "DELETE",
          });
          const result = await response.json();

          document.getElementById(
            "tableDataContent"
          ).innerHTML = `<div class="success">${result.message}</div>`;

          // í†µê³„ ìƒˆë¡œê³ ì¹¨
          loadStats();
          loadTables();
        } catch (error) {
          console.error("í…Œì´ë¸” ì‚­ì œ ì‹¤íŒ¨:", error);
          document.getElementById("tableDataContent").innerHTML =
            '<div class="error">í…Œì´ë¸” ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
      }


      // ì „ì²´ ë‚´ìš© ë³´ê¸°
      function showFullContent(columnName, content) {
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.querySelector(".overlay");
        if (existingModal) {
          existingModal.remove();
        }

        // ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.createElement("div");
        overlay.className = "overlay";
        overlay.onclick = () => overlay.remove();

        // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
        const modal = document.createElement("div");
        modal.className = "full-content";
        modal.onclick = (e) => e.stopPropagation();

        let displayContent = content;
        if (typeof content === "object" && content !== null) {
          displayContent = JSON.stringify(content, null, 2);
        }

        modal.innerHTML = `
                <h3>ğŸ“‹ ${columnName} - ì „ì²´ ë‚´ìš©</h3>
                <pre>${displayContent}</pre>
                <button class="btn btn-secondary" onclick="this.closest('.overlay').remove()" style="margin-top: 16px;">ë‹«ê¸°</button>
            `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
      }

      // ëª¨ë“  ë°ì´í„° ë³´ê¸°
      function loadAllData() {
        const content = document.getElementById("tableDataContent");
        content.innerHTML =
          '<div class="loading">ëª¨ë“  í…Œì´ë¸” ë°ì´í„°ë¥¼ ì¤€ë¹„ ì¤‘...</div>';

        document.getElementById("tableDataSection").style.display = "block";
        document.getElementById("tableDataTitle").textContent =
          "ğŸ“Š ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ê°œìš”";

        // ê°„ë‹¨í•œ ì „ì²´ í†µê³„ í‘œì‹œ
        fetch("/debug/db-stats")
          .then((response) => response.json())
          .then((data) => {
            let html = '<div class="json-display">';
            html += "<h3>ğŸ“ˆ ë°ì´í„°ë² ì´ìŠ¤ í†µê³„</h3>";
            html += `<p><strong>ë°ì´í„°ë² ì´ìŠ¤ URL:</strong> ${data.database_url}</p>`;
            html += `<p><strong>ì´ í…Œì´ë¸” ìˆ˜:</strong> ${data.total_tables}</p>`;
            html += `<p><strong>ì´ ë°ì´í„° í–‰ ìˆ˜:</strong> ${data.total_rows.toLocaleString()}</p>`;
            html += "<h4>í…Œì´ë¸”ë³„ í–‰ ìˆ˜:</h4><ul>";

            Object.entries(data.tables).forEach(([table, count]) => {
              html += `<li><strong>${table}:</strong> ${
                typeof count === "number" ? count.toLocaleString() : count
              } í–‰</li>`;
            });

            html += "</ul></div>";
            content.innerHTML = html;
          })
          .catch((error) => {
            content.innerHTML =
              '<div class="error">í†µê³„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
          });
      }

      // ë°ì´í„° ì¶”ê°€ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
      let referenceData = {};

      function showAddDataModal() {
        document.getElementById("addDataModal").style.display = "flex";
        loadReferenceData();
      }

      function closeAddDataModal() {
        document.getElementById("addDataModal").style.display = "none";
        document.getElementById("tableSelect").value = "";
        document.getElementById("dynamicForm").classList.remove("visible");
        document.getElementById("submitBtn").style.display = "none";
      }

      async function loadReferenceData() {
        try {
          const [mainTopics, subTopics, learningPaths, curriculumItems, levels, users, articles] = await Promise.all([
            fetch("/debug/reference/main-topics").then(r => r.json()),
            fetch("/debug/reference/sub-topics").then(r => r.json()),
            fetch("/debug/reference/learning-paths").then(r => r.json()),
            fetch("/debug/reference/curriculum-items").then(r => r.json()),
            fetch("/debug/reference/levels").then(r => r.json()),
            fetch("/debug/reference/users").then(r => r.json()),
            fetch("/debug/reference/articles").then(r => r.json())
          ]);

          referenceData = {
            mainTopics,
            subTopics,
            learningPaths,
            curriculumItems,
            levels,
            users,
            articles
          };
        } catch (error) {
          console.error("ì°¸ì¡° ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
        }
      }

      function onTableSelectChange() {
        const tableSelect = document.getElementById("tableSelect");
        const selectedTable = tableSelect.value;
        const dynamicForm = document.getElementById("dynamicForm");
        const submitBtn = document.getElementById("submitBtn");

        if (selectedTable) {
          generateForm(selectedTable);
          dynamicForm.classList.add("visible");
          submitBtn.style.display = "block";
        } else {
          dynamicForm.classList.remove("visible");
          submitBtn.style.display = "none";
        }
      }

      function generateForm(tableName) {
        const formContent = document.getElementById("formContent");
        let html = "";

        switch (tableName) {
          case "users":
            html = `
              <div class="form-group">
                <label for="user_id">User ID (ì„ íƒì‚¬í•­ - ìë™ ìƒì„±ë¨):</label>
                <input type="text" id="user_id" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±">
              </div>
              <div class="form-group">
                <label for="nickname">Nickname *:</label>
                <input type="text" id="nickname" required>
              </div>
              <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email">
              </div>
            `;
            break;

          case "levels":
            html = `
              <div class="form-group">
                <label for="level_code">Level Code *:</label>
                <input type="text" id="level_code" required placeholder="ì˜ˆ: beginner, intermediate, expert">
              </div>
              <div class="form-group">
                <label for="name">Name *:</label>
                <input type="text" id="name" required placeholder="ì˜ˆ: ì´ˆê¸‰, ì¤‘ê¸‰, ê³ ê¸‰">
              </div>
              <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" placeholder="ë ˆë²¨ì— ëŒ€í•œ ì„¤ëª…"></textarea>
              </div>
            `;
            break;

          case "main_topics":
            html = `
              <div class="form-group">
                <label for="name">Name *:</label>
                <input type="text" id="name" required placeholder="ë©”ì¸ í† í”½ ì´ë¦„">
              </div>
              <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" placeholder="ë©”ì¸ í† í”½ì— ëŒ€í•œ ì„¤ëª…"></textarea>
              </div>
            `;
            break;

          case "sub_topics":
            html = `
              <div class="form-group">
                <label for="main_topic_id">Main Topic *:</label>
                <select id="main_topic_id" required>
                  <option value="">ë©”ì¸ í† í”½ì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.mainTopics?.map(topic => 
                    `<option value="${topic.id}">${topic.name}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="name">Name *:</label>
                <input type="text" id="name" required placeholder="ì„œë¸Œ í† í”½ ì´ë¦„">
              </div>
              <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" placeholder="ì„œë¸Œ í† í”½ì— ëŒ€í•œ ì„¤ëª…"></textarea>
              </div>
              <div class="form-group">
                <label for="source_type">Source Type:</label>
                <select id="source_type">
                  <option value="curated">Curated (ì§ì ‘ ìƒì„±)</option>
                  <option value="generated">Generated (ìë™ ìƒì„±)</option>
                </select>
              </div>
            `;
            break;

          case "learning_paths":
            html = `
              <div class="form-group">
                <label for="path_id">Path ID (ì„ íƒì‚¬í•­ - ìë™ ìƒì„±ë¨):</label>
                <input type="text" id="path_id" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±">
              </div>
              <div class="form-group">
                <label for="sub_topic_id">Sub Topic *:</label>
                <select id="sub_topic_id" required>
                  <option value="">ì„œë¸Œ í† í”½ì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.subTopics?.map(topic => 
                    `<option value="${topic.id}">${topic.name}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="title">Title *:</label>
                <input type="text" id="title" required placeholder="í•™ìŠµ ê²½ë¡œ ì œëª©">
              </div>
              <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" placeholder="í•™ìŠµ ê²½ë¡œì— ëŒ€í•œ ì„¤ëª…"></textarea>
              </div>
              <div class="form-group">
                <label>
                  <input type="checkbox" id="is_default"> ê¸°ë³¸ ê²½ë¡œë¡œ ì„¤ì •
                </label>
              </div>
            `;
            break;

          case "curriculum_items":
            html = `
              <div class="form-group">
                <label for="curriculum_item_id">Curriculum Item ID (ì„ íƒì‚¬í•­ - ìë™ ìƒì„±ë¨):</label>
                <input type="text" id="curriculum_item_id" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±">
              </div>
              <div class="form-group">
                <label for="sub_topic_id">Sub Topic *:</label>
                <select id="sub_topic_id" required onchange="loadPathsForSubTopic(this.value)">
                  <option value="">ì„œë¸Œ í† í”½ì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.subTopics?.map(topic => 
                    `<option value="${topic.id}">${topic.name}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="path_id">Learning Path *:</label>
                <select id="path_id" required>
                  <option value="">ë¨¼ì € ì„œë¸Œ í† í”½ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
              </div>
              <div class="form-group">
                <label for="title">Title *:</label>
                <input type="text" id="title" required placeholder="ì»¤ë¦¬í˜ëŸ¼ ì•„ì´í…œ ì œëª©">
              </div>
              <div class="form-group">
                <label for="sort_order">Sort Order *:</label>
                <input type="number" id="sort_order" required min="1" placeholder="ì •ë ¬ ìˆœì„œ">
              </div>
            `;
            break;

          case "articles":
            html = `
              <div class="form-group">
                <label for="article_id">Article ID (ì„ íƒì‚¬í•­ - ìë™ ìƒì„±ë¨):</label>
                <input type="text" id="article_id" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±">
              </div>
              <div class="form-group">
                <label for="curriculum_item_id">Curriculum Item *:</label>
                <select id="curriculum_item_id" required>
                  <option value="">ì»¤ë¦¬í˜ëŸ¼ ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.curriculumItems?.map(item => 
                    `<option value="${item.id}">${item.title}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="sub_topic_id">Sub Topic *:</label>
                <select id="sub_topic_id" required>
                  <option value="">ì„œë¸Œ í† í”½ì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.subTopics?.map(topic => 
                    `<option value="${topic.id}">${topic.name}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="level_code">Level *:</label>
                <select id="level_code" required>
                  <option value="">ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.levels?.map(level => 
                    `<option value="${level.code}">${level.name}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="title">Title *:</label>
                <input type="text" id="title" required placeholder="ì•„í‹°í´ ì œëª©">
              </div>
              <div class="form-group">
                <label for="body">Body *:</label>
                <textarea id="body" required placeholder="ì•„í‹°í´ ë‚´ìš©" style="min-height: 200px;"></textarea>
              </div>
            `;
            break;

          case "user_article_reads":
            html = `
              <div class="form-group">
                <label for="user_id">User *:</label>
                <select id="user_id" required>
                  <option value="">ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.users?.map(user => 
                    `<option value="${user.id}">${user.nickname}</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="article_id">Article *:</label>
                <select id="article_id" required>
                  <option value="">ì•„í‹°í´ì„ ì„ íƒí•˜ì„¸ìš”</option>
                  ${referenceData.articles?.map(article => 
                    `<option value="${article.id}">${article.title} (${article.level_code})</option>`
                  ).join('') || ''}
                </select>
              </div>
              <div class="form-group">
                <label for="read_at">Read At (ì„ íƒì‚¬í•­ - í˜„ì¬ ì‹œê°„ ì‚¬ìš©):</label>
                <input type="datetime-local" id="read_at">
              </div>
            `;
            break;
        }

        formContent.innerHTML = html;
      }

      function loadPathsForSubTopic(subTopicId) {
        const pathSelect = document.getElementById("path_id");
        pathSelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';

        if (!subTopicId) {
          pathSelect.innerHTML = '<option value="">ë¨¼ì € ì„œë¸Œ í† í”½ì„ ì„ íƒí•˜ì„¸ìš”</option>';
          return;
        }

        const filteredPaths = referenceData.learningPaths?.filter(path => 
          path.sub_topic_id == subTopicId
        ) || [];

        pathSelect.innerHTML = filteredPaths.length > 0 
          ? `<option value="">í•™ìŠµ ê²½ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>${filteredPaths.map(path => 
              `<option value="${path.id}">${path.title}</option>`
            ).join('')}`
          : '<option value="">í•´ë‹¹ ì„œë¸Œ í† í”½ì— í•™ìŠµ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤</option>';
      }

      async function submitData() {
        const tableSelect = document.getElementById("tableSelect");
        const selectedTable = tableSelect.value;

        if (!selectedTable) {
          alert("í…Œì´ë¸”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const formData = collectFormData(selectedTable);
        
        try {
          const endpoint = getEndpointForTable(selectedTable);
          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.detail || "ë°ì´í„° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
          }

          alert("ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
          closeAddDataModal();
          
          // í…Œì´ë¸” ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          loadTables();
          
          // í˜„ì¬ ì„ íƒëœ í…Œì´ë¸”ì´ ìˆë‹¤ë©´ ìƒˆë¡œê³ ì¹¨
          if (currentTable) {
            loadTableData(currentTable, currentPage);
          }

        } catch (error) {
          alert(`ì˜¤ë¥˜: ${error.message}`);
        }
      }

      function collectFormData(tableName) {
        const formData = {};
        const form = document.getElementById("formContent");
        const inputs = form.querySelectorAll("input, select, textarea");

        inputs.forEach(input => {
          if (input.type === "checkbox") {
            formData[input.id] = input.checked;
          } else if (input.value.trim()) {
            formData[input.id] = input.value.trim();
          }
        });

        return formData;
      }

      function getEndpointForTable(tableName) {
        const endpoints = {
          "users": "/debug/data/users",
          "levels": "/debug/data/levels", 
          "main_topics": "/debug/data/main-topics",
          "sub_topics": "/debug/data/sub-topics",
          "learning_paths": "/debug/data/learning-paths",
          "curriculum_items": "/debug/data/curriculum-items",
          "articles": "/debug/data/articles",
          "user_article_reads": "/debug/data/user-article-reads"
        };
        return endpoints[tableName];
      }
    </script>
  </body>
</html>
